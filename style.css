:root {
  --brown-dark:#4B2E2A;
  --brown-mid:#6B4226;
  --paper:#FBF1DB;
  --ink:#2A1C12;
  --gold:#d4af37;

  --envW:min(78vw, 440px);
  --envH:calc(var(--envW)*0.66);
  --sealH:clamp(54px, 8vw, 74px);
  --padT: clamp(20px, 4vh, 28px);
  --padB: clamp(28px, 5vh, 36px);
}

/* ==================== الخطوط ==================== */

/* الخطوط العربية (ستاندر) */
html[lang="ar"] .message.handwrite,
html[lang="ar"] .signature-name,
html[lang="ar"] .btn,
html[lang="ar"] .notice-title,
html[lang="ar"] .notice-text {
  font-family: "Tahoma","Arial","Helvetica Neue",sans-serif;
}

/* خط إنكليزي (Great Vibes) */
@import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
html[lang="en"] .message.handwrite {
  font-family: "Great Vibes", cursive;
}

/* رسالة البداية */
html[lang="ar"] .notice-title,
html[lang="ar"] .notice-text {
  font-size: 14px;
  line-height: 2;
  direction: rtl;
  text-align: justify;
}

/* نصوص الرسائل */
html[lang="ar"] .message.handwrite {
  font-size: 16px;
  line-height: 1.9;
  direction: rtl;
}

/* التوقيع */
.signature-name {
  font-family: "Great Vibes","Tahoma","Arial",sans-serif;
  font-size: clamp(22px, 4.8vw, 30px);
  color: #4B2E2A;
}

/* ==================== البنية الأساسية ==================== */
* { box-sizing: border-box; }
html, body { height: 100%; }

body {
  margin: 0;
  color: var(--ink);
  font-family: "Tahoma","Arial","Helvetica Neue",sans-serif;
  background:
    radial-gradient(1100px 780px at 40% -10%, #6B4226 0%, #4B2E2A 45%, #2E1C12 100%),
    linear-gradient(0deg, rgba(40,56,40,.12), rgba(40,56,40,.05));
  background-attachment: fixed;
  overflow: hidden;

  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  -webkit-text-size-adjust: 100%;
}

/* ==================== الأزرار ==================== */
.top-actions {
  position: fixed;
  inset: 14px 14px auto auto;
  z-index: 9;
  display: flex;
  gap: 10px;
}
.btn {
  border: none;
  cursor: pointer;
  font-weight: 700;
  letter-spacing: .3px;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 14px;
}
.btn-gold {
  color: #2a1c12;
  background: linear-gradient(145deg, #f5dfb3, #cea242 68%, #b48432 100%);
  border: 1px solid rgba(212,175,55,.7);
  box-shadow: inset 0 2px 3px rgba(255,255,255,.45),
              0 4px 12px rgba(58,40,24,.38);
}
.btn-gold:active { transform: scale(.98); }

/* ==================== الحاوية العامة ==================== */
.stage {
  width: 100%;
  height: 100%;
  display: grid;
  place-items: center;
  perspective: 1400px;
  position: relative;
}

/* ==================== الظرف 3D ==================== */
.envelope3d {
  width: var(--envW);
  height: var(--envH);
  position: relative;
  transform-style: preserve-3d;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 2;
  filter: drop-shadow(0 26px 44px rgba(0,0,0,.48));
  transition: transform .18s ease-out, filter .22s ease;
}
.envelope3d:hover {
  filter: drop-shadow(0 30px 58px rgba(0,0,0,.56));
}

.env {
  position: absolute;
  inset: 0;
  border-radius: 14px;
  pointer-events: none;
}
.env-back {
  background: linear-gradient(var(--brown-dark), #2E1C13);
  border: 2px solid var(--gold);
  transform: translateZ(-4px);
}
.env-front {
  background: linear-gradient(to bottom, var(--brown-mid), var(--brown-dark) 60%, #2E1C13 100%);
  border: 2px solid var(--gold);
  clip-path: polygon(0 35%,100% 35%,100% 100%,0 100%);
  transform: translateZ(2px);
}
.env-flap {
  clip-path: polygon(0 0,100% 0,50% 62%);
  background: linear-gradient(#A47551,#6B4226);
  border: 2px solid var(--gold);
  transform-origin: top center;
  transform: translateZ(6px);
  border-radius: 14px 14px 10px 10px / 14px 14px 20px 20px;
  box-shadow: 0 8px 16px rgba(0,0,0,.32);
}

.env-ribbon {
  position: absolute;
  left: 0; right: 0;
  top: calc(35% - 8px);
  height: 16px;
  background: linear-gradient(90deg, rgba(212,175,55,.9), rgba(255,255,255,.18) 30%, rgba(212,175,55,.9) 70%, rgba(255,255,255,.18));
  border-top: 1px solid rgba(255,255,255,.25);
  border-bottom: 1px solid rgba(0,0,0,.4);
  transform: translateZ(7px);
  border-radius: 14px/12px;
  transition: opacity .6s ease, transform .6s ease;
}

.bow {
  position: absolute;
  left: 50%;
  top: calc(35% - 2px);
  transform: translate(-50%,-50%) translateZ(9px);
  width: 140px;
  height: 56px;
  pointer-events: none;
}
.bow .knot,
.bow .loop,
.bow .tail { position: absolute; }
.bow .knot {
  left: 50%; top: 50%;
  transform: translate(-50%,-50%);
  width: 22px; height: 22px;
  border-radius: 6px;
  background: radial-gradient(circle at 30% 30%, #e9c36a, #c59a3a 70%, #9a7a2d);
}
.bow .loop {
  top: 50%;
  width: 56px; height: 40px;
  border-radius: 50% 50% 40% 40%;
  background: radial-gradient(circle at 40% 30%, #f0d98a, #cfa242 70%, #9a7a2d);
  transition: transform .6s cubic-bezier(.22,.7,.2,1);
}
.bow .loop.left {
  left: 50%;
  transform: translate(-100%,-50%) rotate(-8deg);
  transform-origin: right center;
}
.bow .loop.right {
  left: 50%;
  transform: translate(0,-50%) rotate(8deg);
  transform-origin: left center;
}
.bow .tail {
  top: calc(50% + 14px);
  width: 18px; height: 38px;
  background: linear-gradient(#e9c36a,#bb8d2f);
  clip-path: polygon(0 0, 100% 0, 100% 80%, 50% 100%, 0 80%);
}
.bow .tail.left {
  left: calc(50% - 18px);
  transform: translate(-100%,-50%) rotate(-6deg);
}
.bow .tail.right {
  left: calc(50% + 18px);
  transform: translate(0,-50%) rotate(6deg);
}

/* حركة الاهتزاز */
.stage.shake .envelope3d { animation: shake .36s; }
@keyframes shake {
  0%,100% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-3px); }
}

/* عند الفتح */
.envelope-open .env-flap {
  transform: rotateX(180deg) translateZ(6px);
  transition: transform 1s ease;
}
body.ribbon-loose .env-ribbon { opacity: 0; transform: translateZ(6px) translateY(6px) scaleX(1.06); }
body.ribbon-loose .bow .loop.left { transform: translate(-100%,-48%) rotate(-26deg) scaleX(1.05); }
body.ribbon-loose .bow .loop.right { transform: translate(0,-48%) rotate(26deg) scaleX(1.05); }
body.ribbon-loose .bow .tail.left { transform: translate(-118%,-38%) rotate(-18deg); }
body.ribbon-loose .bow .tail.right { transform: translate(18%,-38%) rotate(18deg); }
/* ==================== القلوب ==================== */
.hearts { 
  position: fixed; 
  inset: 0; 
  pointer-events: none; 
  z-index: 7; 
}
.heart {
  position: fixed;
  width: 18px; height: 18px;
  transform: rotate(-45deg);
  opacity: 0;
  background: linear-gradient(135deg, #d4af37, #ff9aa2);
  filter: drop-shadow(0 4px 10px rgba(212,175,55,.34))
          drop-shadow(0 0 8px rgba(255,154,162,.28));
  animation: floatUp 5.2s linear forwards;
}
.heart::before, .heart::after {
  content:"";
  position: absolute;
  width: 18px; height: 18px;
  background: inherit;
  border-radius: 50%;
}
.heart::before { top: -9px; left: 0; }
.heart::after  { top: 0; left: 9px; }

@keyframes floatUp {
  0%   { transform: translateY(0) scale(.8) rotate(-45deg); opacity:.95; }
  80%  { opacity:.9; }
  100% { transform: translateY(-240px) scale(1.24) rotate(-45deg); opacity:0; }
}

/* ==================== نافذة التعليمات ==================== */
.notice {
  position: fixed; inset: 0;
  display: none;
  align-items: center; justify-content: center;
  background: rgba(24,12,8,.72);
  backdrop-filter: blur(2px);
  z-index: 20;
}
.notice.show { display: flex; }

.notice-box {
  width: min(560px, 88vw);
  background: linear-gradient(180deg, rgba(75,46,42,.94), rgba(212,175,55,.9));
  border: 1px solid rgba(212,175,55,.65);
  border-radius: 16px;
  box-shadow:
    0 20px 46px rgba(0,0,0,.55),
    0 0 30px rgba(212,175,55,.28);
  overflow: hidden;
  font-family: "Tahoma","Arial","Helvetica Neue",sans-serif;
  color: #fdf0d6;
  position: relative;
}
.notice-header {
  display: flex;
  align-items: center; justify-content: space-between;
  padding: 18px 22px;
  background: linear-gradient(180deg, rgba(94,61,48,.9), rgba(212,175,55,.4));
}
.notice-title {
  font-weight: 800;
  font-size: clamp(20px, 3.6vw, 26px);
  color: #fff4dd;
  letter-spacing: 1px;
}
.notice-close {
  border: none; background: transparent;
  font-size: 22px; cursor: pointer;
  color: #f8ead0;
}
.notice.locked .notice-close {
  opacity: .35; pointer-events: none;
}
.notice-text {
  padding: 22px 26px 10px;
  font-size: clamp(14px, 3vw, 18px);
  line-height: 1.9;
  color: #fdf6e8;
  white-space: pre-wrap;
  direction: rtl;
  text-align: start;
  max-height: min(62vh, 520px);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}
.notice-text { scrollbar-width: none; }
.notice-text::-webkit-scrollbar { width: 0; height: 0; }

.notice-actions {
  display: flex;
  justify-content: center;
  padding: 18px 0 26px;
}
.notice-ok {
  width: 78px; height: 78px;
  border-radius: 50%;
  border: 2px solid rgba(212,175,55,.65);
  background: radial-gradient(circle at 40% 32%, #f8deb0, #d0a242 68%, #8e6530 100%);
  color: #3f2914;
  font-weight: 600; font-size: 18px;
  letter-spacing: .6px;
  cursor: pointer;
  box-shadow:
    inset 0 4px 7px rgba(255,255,255,.45),
    0 12px 22px rgba(0,0,0,.45),
    0 0 20px rgba(212,175,55,.45);
}

/* ==================== ريسبونسف ==================== */
@media (max-width: 600px) {
  :root { --envW: 86vw; }
  .message.handwrite { --text-size: 18px; --line: 1.85; }
  .paper { padding: calc(14px + var(--sealH) + 14px) 18px 64px; }
  .message-frame::before, .message-frame::after { font-size: 16px; }
}

/* ==================== تحسينات النصوص ==================== */
.message-frame {
  font-size: var(--text-size);
  line-height: var(--line);
  transition: font-size .24s ease, line-height .24s ease;
}
.message.handwrite {
  margin: 0;
  transform-origin: top center;
  will-change: font-size, transform;
}
.caret { transform-origin: top left; }

/* مساحة إضافية للختم + التوقيع */
:root {
  --padX: clamp(18px, 3.2vw, 28px);
  --padT: clamp(16px, 2.8vh, 22px);
  --padB: clamp(24px, 4.6vh, 32px);
  --sigH: clamp(56px, 10vh, 90px);
}
.paper {
  padding: calc(var(--padT) + var(--sealH)) var(--padX) calc(var(--padB) + var(--sigH));
}
.message-frame {
  max-height: calc(100% - var(--sealH) - var(--sigH) - 84px);
}

/* First line subtle glow */
.message.handwrite::first-line {
  text-shadow: 0 0 8px rgba(212,175,55,.22),
               0 0 14px rgba(212,175,55,.12);
}

/* موبايل */
@media (max-width: 600px) {
  .message.handwrite {
    --text-size: 14px;
    --line: 1.7;
    text-align: justify;
    padding: 0 8px;
  }
  .paper {
    padding: calc(var(--padT) + var(--sealH) + 10px)
             calc(var(--padX) - 2px)
             calc(var(--padB) + var(--sigH) - 4px);
    border-radius: 14px;
  }
}
